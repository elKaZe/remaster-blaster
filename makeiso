#!/bin/bash
umount jail/proc
rm -v iso/casper/filesystem.squashfs jail/etc/mtab
rm -v jail/var/cache/apt/archives/*.deb
rm -rv jail/tmp/*
cp -vf splash.png iso/isolinux/
cp -vf isolinux.cfg iso/isolinux/

mksquashfs jail iso/casper/filesystem.squashfs || {
    echo "No se pudo crear filesystem.squashfs"
    exit 1
}

pushd iso

chroot ../jail dpkg-query -W --showformat='${Package} ${Version}\n' > casper/filesystem.manifest
cp casper/filesystem.manifest{,-desktop}
sed -i -e '/ubiquity/d' -e '/casper/d' casper/filesystem.manifest-desktop

md5sum casper/* > md5sum.txt

printf $(du -sx --block-size=1 ../jail | cut -f1) > casper/filesystem.size

xorriso -as genisoimage \
    -D -r -J -joliet-long -l -V "$1" \
    -b isolinux/isolinux.bin \
    -c isolinux/boot.cat \
    -iso-level 3 -no-emul-boot -partition_offset 16 -boot-load-size 4 -boot-info-table \
    -isohybrid-mbr /usr/lib/syslinux/bios/isohdpfx.bin \
    -o ../"${1// /-}"-$(date +%Y.%m.%d).iso .

popd

exit $?
